# Чеклист для перехода на продакшн YooKassa

## 1. Переменные окружения

### GitHub Secrets / Helm Values
- [ ] `YOOKASSA_SHOP_ID` - заменить на продакшн Shop ID
- [ ] `YOOKASSA_SECRET_KEY` - заменить на продакшн Secret Key
- [ ] `PUBLIC_URL` - убедиться, что указан правильный продакшн URL

### Дополнительные настройки (опционально)
- [ ] `AVAILABLE_STAR_AMOUNTS` - добавить больше вариантов (например: `50,100,200,500,1000,2500,5000`)
- [ ] `USD_RUB_RATE` - обновить актуальный курс USD/RUB
- [ ] `PRICE_50_STARS_USD` - проверить актуальную цену на Fragment

## 2. Настройки в личном кабинете YooKassa

- [ ] **Webhook URL**: `https://bot***/api/yookassa/webhook` (или ваш продакшн URL)
- [ ] **События webhook** (включить):
  - [ ] `payment.succeeded`
  - [ ] `payment.canceled`
  - [ ] `payment.waiting_for_capture`
  - [ ] `refund.succeeded`
- [ ] **Настройки магазина**:
  - [ ] Название магазина
  - [ ] Описание
  - [ ] Контактная информация

## 3. Добавить варианты покупок

Сейчас доступна только **50 звезд**. Для добавления больше вариантов:

```env
AVAILABLE_STAR_AMOUNTS=50,100,200,500,1000,2500,5000
```

Цены рассчитываются автоматически с учетом:
- Базовой стоимости (зависит от `PRICE_50_STARS_USD`)
- Наценки по объему (чем больше, тем меньше наценка)
- Комиссии эквайринга (3% по умолчанию)

**Текущие наценки:**
- 50-99: 20% + 3% = 23%
- 100-199: 18% + 3% = 21%
- 200-499: 16% + 3% = 19%
- 500-999: 14% + 3% = 17%
- 1000-2499: 12% + 3% = 15%
- 2500-4999: 10% + 3% = 13%
- 5000-9999: 8% + 3% = 11%
- 10000+: 6% + 3% = 9%

## 4. Убрать тестовую логику (опционально)

**Текущее состояние:**
- Все покупки считаются тестовыми (`isTestClaimAmount` всегда возвращает `true`)
- Все покупки требуют whitelist
- Каждый пользователь может купить только один раз

**Для продакшна можно:**
1. **Оставить как есть** - если нужны только тестовые покупки с whitelist
2. **Разделить тестовые и обычные** - изменить логику в `star-amounts.config.ts`:
   - Тестовые: только 50 звезд (whitelist, один раз)
   - Обычные: все остальные суммы (без whitelist, без ограничений)

**Файлы для изменения:**
- `src/modules/gateway/config/star-amounts.config.ts` - функция `isTestClaimAmount`
- `src/modules/gateway/config/star-amounts.config.ts` - функция `getRegularPurchaseAmounts`

## 5. Проверка перед запуском

- [ ] **Webhook URL доступен** - проверить доступность `https://********/api/yookassa/webhook`
- [ ] **База данных** - миграции применены
- [ ] **Fragment cookies** - валидны и не истекли (`FRAGMENT_COOKIES`, `FRAGMENT_API_HASH`)
- [ ] **Баланс USDT** - достаточен для покупок
- [ ] **Прокси** - настроены (если используются)
- [ ] **TON кошелек** - настроен и имеет достаточный баланс

## 6. Тестирование

- [ ] **Тестовая покупка** на минимальную сумму (50 звезд)
- [ ] **Проверка webhook** - убедиться, что YooKassa отправляет webhook
- [ ] **Проверка сообщений** - сообщения в Telegram обновляются корректно
- [ ] **Проверка базы данных** - записи создаются и обновляются правильно
- [ ] **Проверка Fragment** - звезды успешно покупаются и отправляются

## 7. Мониторинг

- [ ] **Алерты** - настроены уведомления об ошибках (уже есть `NotificationsService`)
- [ ] **Логирование** - проверка корректности логов
- [ ] **Метрики** - проверка метрик в Grafana (если используется)

## 8. Дополнительные улучшения (опционально)

- [ ] **Кастомные суммы** - если нужно, можно включить ввод произвольной суммы
- [ ] **Промокоды/скидки** - добавить систему промокодов
- [ ] **История покупок** - добавить команду для просмотра истории
- [ ] **Статистика** - добавить админ-панель для статистики продаж

## Важные замечания

1. **Email в чеках**: Сейчас используется email пользователя из базы данных. Убедитесь, что пользователи вводят корректные email.

2. **Webhook security**: YooKassa может отправлять подписанные webhook. Если нужно, можно добавить проверку подписи.

3. **Rate limiting**: Убедитесь, что есть защита от спама/злоупотреблений.

4. **Backup**: Настройте регулярные бэкапы базы данных.

5. **SSL сертификат**: Убедитесь, что SSL сертификат валиден для webhook URL.

